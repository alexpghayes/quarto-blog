{
  "hash": "c1b30c7b3934f37895eef8de0b559ef5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"multilaterion\"\nsubtitle: |\n  a clever way to use `stats::nls()` and a modeling problem that seems tricky for bayesians\ndate: \"2024-11-21\"\nbibliography: multilateration.bib\n---\n\n\n\n2024-11-23 update: some code in the initial version of this blog post was incorrect, and as a result the second half of the post is now incoherent ðŸ˜¬. Thanks to Jouni Helske for pointing me in the direction of the bug.\n\n## Motivation\n\nIn a somewhat unfortunate turn of events my car was totalled a month ago. It was parked on the side of the road, someone driving down the road fell asleep, and then they woke up when they hit my car. Luckily, the driver wasn't injured, and no one else was involved.\n\nThe crash happened early in the morning, so I heard it through my window. I made to the crash at almost the same time as the Madison police, which shocked me. It turned out that the driver's iPhone automatically detected a crash and called the police. How did they know where to go?\n\nThe real answer, of course, is GPS, but in the interest of telling a simpler story, I'm going to pretend that GPS doesn't exist[^gps-note]. Instead, we'll assume that emergency services can detect how close the iPhone was to several cell towers in the Madison area, and show how these multiple distance measurements can be used to back out the location of the crash, a process known as *trilaterion*, or *multilaterion* when more than three distance measurements are used.\n\n[^gps-note]: For readers interested in learning far more about multilaterion and GPS, I highly recommend *Pinpoint* by Greg Milner.\n\n    [![](pinpoint.jpg){width=35% fig-align=\"center\"}](https://www.goodreads.com/book/show/32191741-pinpoint)\n\nIn this post, I'll demonstrate how to perform multilateration using non-linear least squares in R, and then I'll point out a setting where Bayesian methods (at least, my naive approaches) run into fairly substantial problems. I would love to see how Bayesians approach this problem.\n\n## Multilaterion via `stats::nls()` \n\nAlright, so let's assume that the emergency services department has access to several different distance measurements, each measurement coming from a different [cell tower](https://www.city-data.com/towers/cell-Madison-Wisconsin.html) in the Madison area.\n\n\n\n::: {.cell messsage='false'}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndistances <- tribble(\n  ~address,                ~latitude,  ~longitude, ~dist_meters,\n  \"149 Wabesa Street\",     43.097222,  -89.342306,         3008,\n  \"1844 Fordem Avenue\",    43.096389,  -89.363333,         1690,\n  \"122 W. Main Street\",    43.072722,  -89.385194,         1490,\n  \"600 Highland Ave\",      43.075556,  -89.431944,         4794,\n  \"1410 Regent Street\",    43.068056,  -89.409444,         3347\n)\n```\n:::\n\n\n\nTo find the crash site, we would like to find a point such that distances from the cell towers to the point match the measurements as closely as possible. If we have three or more measurements, the point that minimizes these these deviations is uniquely determined. As [Mike Tuupola](https://www.appelsiini.net/2017/trilateration-with-n-points/) demonstrates, we can use `stats::nls()` to find this minimizer with a minimum of fuss^[It would also be straightforward to solve this problem in Jax, or using a number of other approaches, and `stats::nls()` is a little less stable than you might hope, but the convenience factor is hard to beat, especially for quick scratch work.].\n\nTo understand how this works, let's first consider the `geodist::geodist()` function, which is a function that calculates distances between (latitude, longitude) pairs using a performant C++ implementation.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_latitude <- mean(distances$latitude)\nmean_longitude <- mean(distances$longitude)\n\ngeodist(\n  distances,\n  c(\n    longitude = mean_longitude,\n    latitude = mean_latitude\n  ),\n  measure = \"geodesic\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         [,1]\n[1,] 3972.348\n[2,] 2469.886\n[3,] 1034.533\n[4,] 3773.646\n[5,] 2429.934\n```\n\n\n:::\n:::\n\n\n\nWe can pass this distance-calculation almost directly to `stats::nls()`, asking for the point that minimizes average deviation from the observed distances^[Note that we do not need to provide any gradient information to `nls()`, and that the `geodist()` can be an essentially arbitrary function, provided the non-linear least squares minimizer is unique.].\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnls_fit <- nls(\n\n  # dist_meters is the outcome to predict, geodist() is a performant \n  # C++ function that calculates distances between (lat, long) pairs \n  dist_meters ~ geodist(\n    distances,\n    c(\n      longitude = longitude,\n      latitude = latitude\n    ),\n    measure = \"geodesic\"\n  ),\n\n  data = distances,\n\n  # initialize estimated position of crash site as the \"average\"\n  # position of the cell towers\n  start = c(\n    longitude = mean_longitude,\n    latitude = mean_latitude\n  ),\n\n  # add a fudge factor to avoid optimization issues\n  # related to (near) perfect fits\n  control = list(\n    scaleOffset = 1\n  )\n)\n\nnls_fit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNonlinear regression model\n  model: dist_meters ~ geodist(distances, c(longitude = longitude, latitude = latitude),     measure = \"geodesic\")\n   data: distances\nlongitude  latitude \n   -89.37     43.08 \n residual sum-of-squares: 0.1845\n\nNumber of iterations to convergence: 4 \nAchieved convergence tolerance: 8.987e-06\n```\n\n\n:::\n:::\n\n\n\nThe estimated parameters are the estimated location of the crash site. We see that the estimated crash site (red) is right at Breese Stevens field, exactly where it should be.\n\n<!-- https://stackoverflow.com/questions/48383990/convert-sequence-of-longitude-and-latitude-to-polygon-via-sf-in-r -->\n<!-- https://r-charts.com/spatial/interactive-maps-leaflet/#polygons -->\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nleaflet_data <- distances |>\n  mutate(\n    color = \"blue\",\n    label_chr = glue(\n      \"<p>Cell Tower</p>\n       <p>{address}</p>\n       <p>{round(dist_meters)} meters from crash</p>\"\n    ),\n    label_html = map(label_chr, htmltools::HTML),\n  )\n\nleaflet_nls_data <- tibble(\n  latitude = coef(nls_fit)[\"latitude\"],\n  longitude = coef(nls_fit)[\"longitude\"],\n  color = \"red\",\n  label_html = htmltools::HTML(\"Estimated crash site\")\n)\n\nbase_map <- leaflet() |>\n  addTiles() |>\n  setView(\n    lng = mean_longitude,\n    lat = mean_latitude,\n    zoom = 13\n  ) |>\n  addCircleMarkers(\n    data = leaflet_data,\n    color = leaflet_data$color,\n    label = leaflet_data$label_html\n  )\n  \nbase_map |>\n  addCircleMarkers(\n    data = leaflet_nls_data,\n    color = leaflet_nls_data$color,\n    label = leaflet_nls_data$label_html\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-4ff9d2d88ffad30297bf\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-4ff9d2d88ffad30297bf\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[43.097222,43.096389,43.072722,43.075556,43.068056],[-89.34230599999999,-89.363333,-89.385194,-89.431944,-89.40944399999999],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"fillOpacity\":0.2},null,null,null,null,[\"<p>Cell Tower<\\/p>\\n<p>149 Wabesa Street<\\/p>\\n<p>3008 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1844 Fordem Avenue<\\/p>\\n<p>1690 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>122 W. Main Street<\\/p>\\n<p>1490 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>600 Highland Ave<\\/p>\\n<p>4794 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1410 Regent Street<\\/p>\\n<p>3347 meters from crash<\\/p>\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addCircleMarkers\",\"args\":[43.08335799073488,-89.37404328631433,10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":\"red\",\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":\"red\",\"fillOpacity\":0.2},null,null,null,null,\"Estimated crash site\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"setView\":[[43.081989,-89.3864442],13,[]],\"limits\":{\"lat\":[43.068056,43.097222],\"lng\":[-89.431944,-89.34230599999999]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nIn this constructed data, the distance measurements are all exact, and so it doesn't make a ton of sense to consider estimation uncertainty, but we can also consider the case where distances are subject to some kind of measurement error or truncation. For instance, suppose that the measurement devices in the cell towers only report two significant digits and round the rest of the data. In this case, we see that there `nls()` estimates, under a Gaussian error model, have substantial uncertainty in the location of the crash site. If you're struggling to see the difference between the maps, try zooming in on the estimated crash sites.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndistances_rounded <- distances  |>\n  mutate(\n    dist_meters_rounded = signif(dist_meters, digits = 2)\n  ) |> \n  # subset to only the necessary columns of data to avoid nls() errors\n  select(latitude, longitude, dist_meters_rounded)\n\nnls_fit_rounded <- nls(\n  dist_meters_rounded ~ geodist(\n    distances_rounded,\n    c(\n      longitude = longitude,\n      latitude = latitude\n    ),\n    measure = \"geodesic\"\n  ),\n  data = distances_rounded,\n  start = c(\n    longitude = mean_longitude,\n    latitude = mean_latitude\n  ),\n  control = list(\n    scaleOffset = 1\n  )\n)\n\n# ellipse should be a two-column matrix of longitude, latitude data points\nmake_leaflet_polygon <- function(ellipse) {\n  ellipse |>\n    as.data.frame() |>\n    set_names(\n      c(\"longitude\", \"latitude\")\n    ) |>\n\n    # turn uncertainty ellipse into sf object\n    st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326) |>\n    summarize(geometry = st_combine(geometry)) |>\n    st_cast(\"POLYGON\") |>\n\n    # convert to leaflet projection\n    st_transform(crs = '+proj=longlat +datum=WGS84')\n}\n\nnls_ellipse <- nls_fit_rounded |> \n  ellipse() |> \n  make_leaflet_polygon()\n\nleaflet_data_rounded <- distances  |>\n  mutate(\n    dist_meters_rounded = signif(dist_meters, digits = 2)\n  ) |>\n  mutate(\n    color = \"blue\",\n    label_chr = glue(\n      \"<p>Cell Tower</p>\n       <p>{address}</p>\n       <p>{dist_meters_rounded} meters from crash</p>\"\n    ),\n    label_html = map(label_chr, htmltools::HTML),\n  )\n\nbase_map_rounded <- leaflet() |>\n  addTiles() |>\n  setView(\n    lng = mean_longitude,\n    lat = mean_latitude,\n    zoom = 13\n  ) |>\n  addCircleMarkers(\n    data = leaflet_data_rounded,\n    color = leaflet_data_rounded$color,\n    label = leaflet_data_rounded$label_html\n  )\n\nbase_map_rounded |> \n  addPolygons(\n    data = nls_ellipse,\n    color = \"red\",\n    stroke = 1,\n    label = htmltools::HTML(\"95% confidence ellipse for crash site\")\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-f3c8ba2f87961dec7454\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f3c8ba2f87961dec7454\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[43.097222,43.096389,43.072722,43.075556,43.068056],[-89.34230599999999,-89.363333,-89.385194,-89.431944,-89.40944399999999],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"fillOpacity\":0.2},null,null,null,null,[\"<p>Cell Tower<\\/p>\\n<p>149 Wabesa Street<\\/p>\\n<p>3000 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1844 Fordem Avenue<\\/p>\\n<p>1700 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>122 W. Main Street<\\/p>\\n<p>1500 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>600 Highland Ave<\\/p>\\n<p>4800 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1410 Regent Street<\\/p>\\n<p>3300 meters from crash<\\/p>\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addPolygons\",\"args\":[[[[{\"lng\":[-89.37368414285136,-89.37377239011447,-89.37386205464949,-89.37395277540902,-89.37404418709255,-89.37413592161751,-89.37422760960135,-89.37431888184889,-89.37440937083905,-89.37449871220456,-89.37458654619928,-89.37467251914674,-89.3747562848642,-89.37483750605671,-89.37491585567516,-89.3749910182333,-89.37506269107804,-89.37513058560813,-89.37519442843626,-89.37525396248991,-89.37530894804642,-89.37535916369839,-89.37540440724511,-89.37544449650679,-89.37547927005811,-89.37550858787826,-89.37553233191471,-89.37555040655862,-89.37556273902977,-89.37556927966968,-89.37557000214147,-89.375564903536,-89.37555400438357,-89.37553734857121,-89.37551500316602,-89.37548705814503,-89.37545362603299,-89.37541484144921,-89.37537086056554,-89.37532186047746,-89.37526803849101,-89.37520961132837,-89.37514681425509,-89.3750799001328,-89.37500913840108,-89.37493481399245,-89.37485722618506,-89.37477668739761,-89.37469352193139,-89.37460806466439,-89.37452065970284,-89.37443165899569,-89.37434142091736,-89.37425030882476,-89.37415868959411,-89.37406693214373,-89.37397540594847,-89.37388447955205,-89.37379451908294,-89.3737058867802,-89.37361893953485,-89.37353402745275,-89.3734514924449,-89.37337166685062,-89.37329487209942,-89.37322141741666,-89.37315159857842,-89.37308569672051,-89.37302397720647,-89.37296668855898,-89.37291406145921,-89.37286630781794,-89.3728236199222,-89.37278616966108,-89.37275410783359,-89.37272756354136,-89.37270664366891,-89.37269143245317,-89.37268199114433,-89.37267835775924,-89.37268054692822,-89.3726885498363,-89.37270233425856,-89.37272184469002,-89.37274700256903,-89.37277770659372,-89.37281383312981,-89.37285523670849,-89.37290175061214,-89.37295318754572,-89.37300934039084,-89.37306998303981,-89.37313487130608,-89.37320374390752,-89.37327632351845,-89.37335231788641,-89.3734314210089,-89.37351331436557,-89.37359766820076,-89.37368414285136],\"lat\":[43.08373824331096,43.08381869532214,43.08389717422486,43.08397336401227,43.084046957895,43.08411765953645,43.08418518424607,43.08424926012568,43.08430962916432,43.0843660482772,43.08441829028445,43.08446614482595,43.08450941920835,43.08454793918098,43.08458154963751,43.0846101152405,43.08463352096634,43.08465167256844,43.08466449695671,43.08467194249184,43.08467397919332,43.08467059886004,43.08466181510344,43.08464766329259,43.08462820041184,43.08460350483134,43.08457367599148,43.08453883400247,43.0844991191607,43.08445469138381,43.0844057295668,43.08435243086162,43.08429500988333,43.08423369784597,43.08416874163144,43.08410040279551,43.08402895651456,43.08395469047753,43.08387790372755,43.08379890545775,43.08371801376629,43.08363555437546,43.08355185932012,43.08346726561073,43.08338211387629,43.08329674699277,43.0832115087025,43.08312674222999,43.0830427888999,43.08295998676265,43.08287866923323,43.08279916374864,43.08272179044939,43.08264686089046,43.08257467678673,43.08250552879812,43.08243969535916,43.08237744155789,43.08231901806838,43.0822646601414,43.08221458665715,43.08216899924387,43.08212808146599,43.08209199808496,43.0820608943958,43.08203489564212,43.0820141065117,43.08199861071504,43.08198847064825,43.08198372714179,43.08198439929609,43.08199048440462,43.0820019579648,43.08201877377665,43.08204086412883,43.08206814007129,43.08210049177344,43.08213778896639,43.0821798814675,43.08222659978514,43.08227775580112,43.08233314352823,43.08239253993963,43.08245570586695,43.08252238696328,43.08259231472739,43.08266520758485,43.08274077202184,43.08281870376706,43.08289868901687,43.0829804056989,43.08306352476891,43.08314771153574,43.08323262700901,43.08331792926406,43.08340327481881,43.08348832001686,43.0835727224112,43.08365614214317,43.08373824331096]}]]],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":1,\"color\":\"red\",\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":\"red\",\"fillOpacity\":0.2,\"smoothFactor\":1,\"noClip\":false},null,null,\"95% confidence ellipse for crash site\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"setView\":[[43.081989,-89.3864442],13,[]],\"limits\":{\"lat\":[43.068056,43.097222],\"lng\":[-89.431944,-89.34230599999999]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\nThis looks fairly reasonable to me! The uncertainty in the estimate of the crash site, however, could be poorly estimated. In particular, `nls()` is appropriate for Gaussian errors, but here the distances are interval censored, and so we might want to model that more directly.\n\nTo my eye, the easiest way to try to model interesting and potentially varied error structure, such as censored responses, is to use `brms`. We can start by matching the analysis we've done so far, and then once we have that working, it should hopefully be easy to iterate and consider various assumptions about errors in distance measurements.\n\n## Reaching for the flexible Bayesian modelling toolkit\n\nTo replicate our analysis in Stan, we run into an issue. `geodist::geodist()` is implemented in C++, and the `brms` non-linear interface only supports non-linearities as implemented in either `R` or `Stan` code. We will start by implemented a simpler estimate of geodesic distance, the Haversine distance, in `Stan`. This turns out to look like\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstan_funs <- \"\nreal havdist(real long1, real lat1, real long2, real lat2) {\n  real long1_rad = long1 * pi() / 180;\n  real lat1_rad = lat1 * pi() / 180;\n  real long2_rad = long2 * pi() / 180;\n  real lat2_rad = lat2 * pi() / 180;\n  \n  real diff_long = (long2_rad - long1_rad);\n  real diff_lat = (lat2_rad - lat1_rad);\n  \n  real a = sin(diff_lat / 2)^2 + cos(lat1_rad) * cos(lat2_rad) * sin(diff_long / 2)^2;\n  real b = 2 * atan2(sqrt(a), sqrt(1 - a));\n  \n  return 6378137 * b;\n}\n\"\n```\n:::\n\n\n\nWith this `Stan` code in hand, we specify priors for the latitude and longitude of the crash, and then we'll be ready to model. We'll start with an informative prior that places most of the prior density around the mean latitude and longitude of the cell towers.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake_prior <- function(sigma2 = 0.05) {\n  c(\n    prior_string(\n      glue(\"normal({mean_longitude}, {sigma2})\"),\n      nlpar = \"crashlong\"\n    ),\n    prior_string(\n      glue(\"normal({mean_latitude}, {sigma2})\"),\n      nlpar = \"crashlat\"\n    )\n  )\n}\n\ninformative_prior <- make_prior(0.001)\nuninformative_prior <- make_prior(1)\n\ninformative_prior[, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                      prior class    source\n normal(-89.3864442, 0.001)     b (unknown)\n   normal(43.081989, 0.001)     b (unknown)\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbrm_informative <- brm(\n  bf(\n    dist_meters ~ havdist(longitude, latitude, crashlong, crashlat),\n    crashlong + crashlat ~ 1,\n    nl = TRUE\n  ),\n  data = distances,\n  stanvars = stanvar(scode = stan_funs, block = \"functions\"),\n  prior =  informative_prior,\n  backend = \"cmdstanr\",\n  chains = 4,\n  cores = 4,\n  seed = 27,\n  control = list(adapt_delta = 0.98),\n  silent = 2,\n  refresh = 0\n)\n```\n:::\n\n\n\nThis fit seems reasonable (summary omitted for verbosity reasons) and Stan doesn't issue any warnings, so we visualize the result. Unfortunately, the estimated position of the crash site isn't great, and suggests that the Bayesian variant of our model thinks the crash probably happened in a lake, which is impossible.\n\n::: {.callout-tip}\n## An unrelated question I've been curious about for a while\n\nIs there any way to express a prior like \"the probability of this event is proportional to population density\" or \"this event must have happened on a road\", and then use it is for Bayesian computations in an applied problem?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nbrm_params <- fixef(brm_informative)[, \"Estimate\"] |>\n  set_names(\n    c(\"longitude\", \"latitude\")\n  )\n\nbrm_ellipse <- ellipse(vcov(brm_informative), center = brm_params) |>\n  make_leaflet_polygon()\n\nprior_vcov <- diag(0.001, nrow = 2)\nprior_mean <- c(mean_longitude, mean_latitude)\n\nprior_ellipse <- ellipse(prior_vcov, center = prior_mean) |>\n  make_leaflet_polygon()\n\nbase_map |> \n  addPolygons(\n    data = brm_ellipse,\n    color = \"red\",\n    stroke = 1,\n    label = htmltools::HTML(\"95% credible ellipse for crash site\")\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-813bed64afeea8ee190e\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-813bed64afeea8ee190e\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[43.097222,43.096389,43.072722,43.075556,43.068056],[-89.34230599999999,-89.363333,-89.385194,-89.431944,-89.40944399999999],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"fillOpacity\":0.2},null,null,null,null,[\"<p>Cell Tower<\\/p>\\n<p>149 Wabesa Street<\\/p>\\n<p>3008 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1844 Fordem Avenue<\\/p>\\n<p>1690 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>122 W. Main Street<\\/p>\\n<p>1490 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>600 Highland Ave<\\/p>\\n<p>4794 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1410 Regent Street<\\/p>\\n<p>3347 meters from crash<\\/p>\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addPolygons\",\"args\":[[[[{\"lng\":[-89.38431233958428,-89.38442541639563,-89.38454541665857,-89.3846718571744,-89.38480422881177,-89.38494199855687,-89.38508461165949,-89.38523149386707,-89.38538205373675,-89.38553568501709,-89.38569176908916,-89.38584967745747,-89.38600877428077,-89.38616841893229,-89.38632796857938,-89.38648678077192,-89.38664421602924,-89.38679964041515,-89.3869524280905,-89.38710196383325,-89.38724764551571,-89.38738888652921,-89.38752511814602,-89.38765579180948,-89.38778038134288,-89.38789838506815,-89.38800932782596,-89.38811276288892,-89.3882082737606,-89.38829547585239,-89.38837401803225,-89.38844358403855,-89.38850389375354,-89.38855470433128,-89.38859581117551,-89.38862704876345,-89.38864829131241,-89.3886594532861,-89.38866048973919,-89.38865139649828,-89.38863221017861,-89.38860300803675,-89.38856390765939,-89.38851506648997,-89.38845668119463,-89.38838898687034,-89.38831225609826,-89.38822679784614,-89.38813295622418,-89.38803110909949,-89.38792166657447,-89.38780506933557,-89.38768178687869,-89.38755231561879,-89.38741717689093,-89.38727691485109,-89.38713209428496,-89.38698329833389,-89.38683112614662,-89.38667619046687,-89.38651911516592,-89.38636053273059,-89.38620108171635,-89.38604140417617,-89.38588214307515,-89.38572393970152,-89.38556743108444,-89.38541324742887,-89.38526200957799,-89.38511432651322,-89.38497079290214,-89.38483198670396,-89.38469846684224,-89.38457077095433,-89.38444941322651,-89.38433488232353,-89.38422763942089,-89.38412811634791,-89.3840367138489,-89.38395379996945,-89.38387970857448,-89.38381473800391,-89.38375914987128,-89.38371316801037,-89.38367697757394,-89.38365072428807,-89.3836345138655,-89.38362841157986,-89.38363244200292,-89.38364658890556,-89.38367079532324,-89.38370496378522,-89.38374895670718,-89.38380259694516,-89.38386566850883,-89.38393791743128,-89.38401905279159,-89.3841087478863,-89.38420664154495,-89.38431233958428],\"lat\":[43.08408194552117,43.0841852720471,43.08428096929674,43.08436865193104,43.08444796688299,43.08451859477926,43.08458025122624,43.08463268795519,43.08467569382191,43.08470909565694,43.08473275896289,43.08474658845597,43.0847505284497,43.08474456307911,43.08472871636465,43.08470305211544,43.08466767367235,43.0846227234919,43.08456838257258,43.0845048697261,43.08443244069629,43.08435138712927,43.08426203539917,43.08416474529385,43.08405990856623,43.08394794735681,43.08382931249388,43.08370448167815,43.08357395755925,43.08343826571174,43.08329795251881,43.08315358297217,43.08300573839701,43.08285501411125,43.08270201702842,43.08254736321376,43.08239167540358,43.08223558049777,43.08207970703541,43.08192468266392,43.08177113161172,43.08161967217472,43.0814709142266,43.08132545676312,43.08118388549015,43.08104677046524,43.08091466380218,43.08078809744791,43.08066758104046,43.08055359985685,43.08044661285908,43.08034705084604,43.08025531471883,43.08017177386642,43.08009676467837,43.08003058919018,43.07997351386721,43.07992576853162,43.07988754543704,43.07985899849438,43.07984024265209,43.07983135343334,43.07983236663187,43.07984327816789,43.0798640441045,43.07989458082459,43.07993476536758,43.07998443592448,43.08004339248951,43.08011139766538,43.08018817761924,43.08027342318533,43.08036679110985,43.08046790543309,43.08057635900338,43.08069171511647,43.080813509274,43.08094125105389,43.08107442608507,43.08121249811871,43.08135491118744,43.08150109184411,43.08165045147081,43.08180238864902,43.08195629158138,43.08211154055508,43.08226751043729,43.08242357319237,43.08257910041065,43.08273346583895,43.08288604790216,43.08303623220615,43.08318341401175,43.08332700066977,43.08346641400742,43.08360109265639,43.0837304943133,43.08385409792334,43.08397140577841,43.08408194552117]}]]],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":1,\"color\":\"red\",\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":\"red\",\"fillOpacity\":0.2,\"smoothFactor\":1,\"noClip\":false},null,null,\"95% credible ellipse for crash site\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"setView\":[[43.081989,-89.3864442],13,[]],\"limits\":{\"lat\":[43.068056,43.097222],\"lng\":[-89.431944,-89.34230599999999]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\nMaybe the issue was that our prior was too informative and we can improve the Bayesian estimate with a more diffuse prior that regularizes the estimate less stronger towards the mean latitude and longitude of the towers? I went ahead and did this and I am again omitting the model summary for the sake of brevity, but the diagnostics are terrible and Stan warns us we need stronger priors. If we visualize the 95% credible interval for the crash site we get the following.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nbrm_uninformative <- brm(\n  bf(\n    dist_meters ~ havdist(longitude, latitude, crashlong, crashlat),\n    crashlong + crashlat ~ 1,\n    nl = TRUE\n  ),\n  data = distances,\n  stanvars = stanvar(scode = stan_funs, block = \"functions\"),\n  prior =  uninformative_prior,\n  backend = \"cmdstanr\",\n  chains = 4,\n  cores = 4,\n  control = list(adapt_delta = 0.99),\n  seed = 27,\n  silent = 2,\n  refresh = 0\n)\n\nbrm_uninformative_params <- fixef(brm_uninformative)[, \"Estimate\"] |>\n  set_names(\n    c(\"longitude\", \"latitude\")\n  )\n\nbrm_uninformative_ellipse <- ellipse(vcov(brm_uninformative), center = brm_uninformative_params) |>\n  make_leaflet_polygon()\n\nbase_map |> \n  addPolygons(\n    data = brm_uninformative_ellipse,\n    color = \"red\",\n    stroke = 1,\n    label = htmltools::HTML(\"95% credible ellipse for crash site\")\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-a18bae39a5e94d985081\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-a18bae39a5e94d985081\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[43.097222,43.096389,43.072722,43.075556,43.068056],[-89.34230599999999,-89.363333,-89.385194,-89.431944,-89.40944399999999],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"blue\",\"blue\",\"blue\",\"blue\",\"blue\"],\"fillOpacity\":0.2},null,null,null,null,[\"<p>Cell Tower<\\/p>\\n<p>149 Wabesa Street<\\/p>\\n<p>3008 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1844 Fordem Avenue<\\/p>\\n<p>1690 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>122 W. Main Street<\\/p>\\n<p>1490 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>600 Highland Ave<\\/p>\\n<p>4794 meters from crash<\\/p>\",\"<p>Cell Tower<\\/p>\\n<p>1410 Regent Street<\\/p>\\n<p>3347 meters from crash<\\/p>\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addPolygons\",\"args\":[[[[{\"lng\":[-89.37383646401578,-89.37386217998024,-89.3738883569757,-89.37391488959669,-89.3739416710057,-89.37396859336343,-89.37399554826305,-89.37402242716671,-89.37404912184255,-89.37407552480052,-89.37410152972522,-89.37412703190402,-89.37415192864863,-89.37417611970865,-89.37419950767523,-89.37422199837327,-89.37424350124067,-89.37426392969297,-89.37428320147201,-89.37430123897714,-89.37431796957767,-89.37433332590541,-89.37434724612582,-89.3743596741871,-89.37437056004585,-89.37437985986851,-89.37438753620802,-89.37439355815445,-89.37439790145956,-89.37440054863438,-89.37440148901969,-89.37440071882888,-89.37439824116322,-89.37439406599941,-89.37438821014938,-89.37438069719254,-89.37437155738091,-89.37436082751732,-89.37434855080713,-89.37433477668432,-89.37431956061241,-89.37430296386115,-89.37428505325983,-89.37426590092807,-89.3742455839856,-89.37422418424154,-89.37420178786513,-89.37417848503866,-89.37415436959439,-89.37412953863671,-89.37410409215111,-89.37407813260162,-89.37405176451819,-89.37402509407575,-89.37399822866679,-89.37397127646882,-89.37394434600883,-89.37391754572627,-89.37389098353644,-89.37386476639588,-89.37383899987178,-89.37381378771683,-89.37378923145147,-89.37376542995511,-89.37374247906801,-89.37372047120527,-89.37369949498478,-89.37367963487038,-89.37366097083175,-89.37364357802237,-89.37362752647697,-89.37361288082943,-89.37359970005261,-89.37358803722087,-89.37357793929628,-89.37356944693965,-89.37356259434669,-89.37355740911038,-89.37355391210981,-89.3735521174262,-89.3735520322861,-89.37355365703232,-89.3735569851226,-89.3735620031559,-89.37356869092635,-89.37357702150467,-89.37358696134656,-89.37359847042778,-89.37361150240534,-89.37362600480405,-89.37364191922786,-89.37365918159503,-89.37367772239608,-89.37369746697375,-89.3737183358236,-89.37374024491413,-89.37376310602517,-89.37378682710309,-89.37381131263149,-89.37383646401578],\"lat\":[43.08346342032377,43.0834907528797,43.08351736183557,43.08354314004648,43.0835679837127,43.08359179279753,43.08361447143021,43.08363592829188,43.08365607698332,43.08367483637289,43.08369213092313,43.08370789099499,43.08372205312822,43.08373456029692,43.08374536213913,43.08375441515964,43.08376168290513,43.08376713611097,43.08377075281901,43.08377251846604,43.08377242594244,43.08377047562075,43.08376667535425,43.08376104044525,43.08375359358354,43.08374436475503,43.08373339112093,43.08372071686819,43.08370639303157,43.08369047728809,43.08367303372485,43.0836541325809,43.08363384996449,43.08361226754655,43.08358947223186,43.08356555580911,43.0835406145813,43.08351474897794,43.08348806315069,43.08346066455395,43.08343266351222,43.08340417277579,43.08337530706682,43.08334618261731,43.08331691670116,43.08328762716187,43.08325843193808,43.08322944858865,43.08320079381931,43.08317258301269,43.08314492976376,43.08311794542239,43.083091738645,43.08306641495703,43.08304207632804,43.08301882076109,43.08299674189815,43.08297592864299,43.08295646480327,43.08293842875298,43.08292189311695,43.08290692447832,43.08289358311055,43.08288192273459,43.08287199030267,43.08286382580919,43.08285746212968,43.08285292488844,43.08285023235532,43.08284939537221,43.08285041730937,43.08285329405178,43.08285801401583,43.0828645581959,43.08287290024088,43.08288300656029,43.08289483645956,43.08290834230386,43.08292346970991,43.082940157765,43.08295833927222,43.08297794102106,43.08299888408217,43.08302108412526,43.0830444517586,43.08306889288895,43.08309430910052,43.0831205980512,43.08314765388466,43.0831753676566,43.08320362777345,43.0832323204417,43.08326133012608,43.08329054001486,43.0833198324901,43.08334908960136,43.08337819354056,43.08340702711643,43.08343547422632,43.08346342032377]}]]],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":1,\"color\":\"red\",\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":\"red\",\"fillOpacity\":0.2,\"smoothFactor\":1,\"noClip\":false},null,null,\"95% credible ellipse for crash site\",{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"setView\":[[43.081989,-89.3864442],13,[]],\"limits\":{\"lat\":[43.068056,43.097222],\"lng\":[-89.431944,-89.34230599999999]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n**Note:** from here on is incoherent.\n\nThis is obviously not what we'd hope for. The crash site is in fact contained in this interval, but we have more than enough data to completely determine the exact location of the crash site. We're only using five observations, and so the Bayesian posterior has only been slightly updated away from the prior, which in this case continues a fair portion of the Midwest.\n\nIs there any way for a Bayesian to get a reasonable estimate of the position of the crash site? I would love to hear from dedicated Bayesians how they would approach this problem^[If you search for \"Bayesian Multilaterion,\" you are likely to come across @alencar2022, which suggests that a Bayesian approach works well. However, the \"prior\" in this approach is a normal centered on the frequentist point estimate, with variance equal to the corresponding bootstrapped standard error.].\n\nIf you care about coverage properties of your credible interval, @balch2019 states are always some parameters that will be poorly covered by Bayesian credible intervals^[Note that the crash site my multilaterion problem is a simpler variant of the satellite collision problem considered in this paper]. @martin2024d discusses which parameters are suspectible to poor coverage in more detail. \n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}