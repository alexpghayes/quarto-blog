{
  "hash": "7b57a5ba0297e0e44533db74950582a6",
  "result": {
    "markdown": "---\ntitle: \"gentle tidy eval with examples\"\nsubtitle: |\n  copy-pasteable example code for programming with the tidyverse.\ndate: \"2017-08-07\"\ncategories: [rstats, tidyverse, notes to self]\nexecute:\n  echo: true\n  message: false\n  warning: false\n---\n\n\nI've been using the tidy eval framework introduced with `dplyr 0.7` for about two months now, and it's time for an update to my original post on tidy eval. My goal is not to explain tidy eval to you, but rather to show you some simple examples that you can easily generalize from.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\nstarwars\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 87 × 14\n   name     height  mass hair_color skin_color eye_color birth_year sex   gender\n   <chr>     <int> <dbl> <chr>      <chr>      <chr>          <dbl> <chr> <chr> \n 1 Luke Sk…    172    77 blond      fair       blue            19   male  mascu…\n 2 C-3PO       167    75 <NA>       gold       yellow         112   none  mascu…\n 3 R2-D2        96    32 <NA>       white, bl… red             33   none  mascu…\n 4 Darth V…    202   136 none       white      yellow          41.9 male  mascu…\n 5 Leia Or…    150    49 brown      light      brown           19   fema… femin…\n 6 Owen La…    178   120 brown, gr… light      blue            52   male  mascu…\n 7 Beru Wh…    165    75 brown      light      blue            47   fema… femin…\n 8 R5-D4        97    32 <NA>       white, red red             NA   none  mascu…\n 9 Biggs D…    183    84 black      light      brown           24   male  mascu…\n10 Obi-Wan…    182    77 auburn, w… fair       blue-gray       57   male  mascu…\n# … with 77 more rows, and 5 more variables: homeworld <chr>, species <chr>,\n#   films <list>, vehicles <list>, starships <list>\n```\n:::\n:::\n\n\n## Using strings to refer to column names\n\nTo refer to columns in a data frame with strings, we need to convert those strings into symbol objects with `rlang::sym` and `rlang::syms`. We then use the created symbol objects in dplyr functions with the prefixes `!!` and `!!!`. This is because `dplyr` verbs expect input that looks like code. Using the `sym/syms` functions we can convert strings into objects that look like code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmass <- rlang::sym(\"mass\")                        # create a single symbol\ngroups <- rlang::syms(c(\"homeworld\", \"species\"))  # create a list of symbols\n\nstarwars %>%\n  group_by(!!!groups) %>%               # use list of symbols with !!!\n  summarize(avg_mass = mean(!!mass))    # use single symbol with !!\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 58 × 3\n# Groups:   homeworld [49]\n   homeworld      species   avg_mass\n   <chr>          <chr>        <dbl>\n 1 Alderaan       Human         NA  \n 2 Aleen Minor    Aleena        15  \n 3 Bespin         Human         79  \n 4 Bestine IV     Human        110  \n 5 Cato Neimoidia Neimodian     90  \n 6 Cerea          Cerean        82  \n 7 Champala       Chagrian      NA  \n 8 Chandrila      Human         NA  \n 9 Concord Dawn   Human         79  \n10 Corellia       Human         78.5\n# … with 48 more rows\n```\n:::\n:::\n\n\nThe usage `mass <- rlang::sym(\"mass\")` is Hadley approved:\n\n\n{{< tweet id=885993307968593920 hide_thread=true align=center >}}\n\n\n\nI believe it is also the current tidyverse code style standard. We use `rlang::sym` and `rlang::syms` identically inside functions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummarize_by <- function(df, groups, to_summarize) {\n  df %>%\n    group_by(!!!rlang::syms(groups)) %>%\n    summarize(summarized_mean = mean(!!rlang::sym(to_summarize)))\n}\n\nsummarize_by(starwars, c(\"homeworld\", \"species\"), \"mass\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 58 × 3\n# Groups:   homeworld [49]\n   homeworld      species   summarized_mean\n   <chr>          <chr>               <dbl>\n 1 Alderaan       Human                NA  \n 2 Aleen Minor    Aleena               15  \n 3 Bespin         Human                79  \n 4 Bestine IV     Human               110  \n 5 Cato Neimoidia Neimodian            90  \n 6 Cerea          Cerean               82  \n 7 Champala       Chagrian             NA  \n 8 Chandrila      Human                NA  \n 9 Concord Dawn   Human                79  \n10 Corellia       Human                78.5\n# … with 48 more rows\n```\n:::\n:::\n\n\n## Details about unquoting\n\n`!!` and `!!!` are syntactic sugar on top of the functions `UQ()` and `UQS()`, respectively. It used to be that `!!` and `!!!` had low operator precedence, meaning that in terms of PEMDAS they came pretty much last. But now we can use them more intuitively:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhomeworld <- rlang::sym(\"homeworld\")\n\nfilter(starwars, !!homeworld == \"Alderaan\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 14\n  name      height  mass hair_color skin_color eye_color birth_year sex   gender\n  <chr>      <int> <dbl> <chr>      <chr>      <chr>          <dbl> <chr> <chr> \n1 Leia Org…    150    49 brown      light      brown             19 fema… femin…\n2 Bail Pre…    191    NA black      tan        brown             67 male  mascu…\n3 Raymus A…    188    79 brown      light      brown             NA male  mascu…\n# … with 5 more variables: homeworld <chr>, species <chr>, films <list>,\n#   vehicles <list>, starships <list>\n```\n:::\n:::\n\n\nWe can also use `UQ` and `UQS` directly to be explicit about what we're unquoting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter(starwars, UQ(homeworld) == \"Alderaan\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 14\n  name      height  mass hair_color skin_color eye_color birth_year sex   gender\n  <chr>      <int> <dbl> <chr>      <chr>      <chr>          <dbl> <chr> <chr> \n1 Leia Org…    150    49 brown      light      brown             19 fema… femin…\n2 Bail Pre…    191    NA black      tan        brown             67 male  mascu…\n3 Raymus A…    188    79 brown      light      brown             NA male  mascu…\n# … with 5 more variables: homeworld <chr>, species <chr>, films <list>,\n#   vehicles <list>, starships <list>\n```\n:::\n:::\n\n\n## Creating non-standard functions\n\nSometimes it is nice to write functions that use accept non-standard inputs, like `dplyr` verbs. For example, we might want to write a function with the same effect as\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars %>% \n  group_by(homeworld, species) %>% \n  summarize(avg_mass = mean(mass))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 58 × 3\n# Groups:   homeworld [49]\n   homeworld      species   avg_mass\n   <chr>          <chr>        <dbl>\n 1 Alderaan       Human         NA  \n 2 Aleen Minor    Aleena        15  \n 3 Bespin         Human         79  \n 4 Bestine IV     Human        110  \n 5 Cato Neimoidia Neimodian     90  \n 6 Cerea          Cerean        82  \n 7 Champala       Chagrian      NA  \n 8 Chandrila      Human         NA  \n 9 Concord Dawn   Human         79  \n10 Corellia       Human         78.5\n# … with 48 more rows\n```\n:::\n:::\n\n\nTo this we need to capture our input in `quosures` with `quo` and `quos` when programming interactively.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngroups <- quos(homeworld, species)   # capture a list of variables as raw input\nmass <- quo(mass)                    # capture a single variable as raw input\n\nstarwars %>% \n  group_by(!!!groups) %>%            # use !!! to access variables from `quos`\n  summarize(avg_mass = sum(!!mass))  # use !! to access the variable in `quo`\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 58 × 3\n# Groups:   homeworld [49]\n   homeworld      species   avg_mass\n   <chr>          <chr>        <dbl>\n 1 Alderaan       Human           NA\n 2 Aleen Minor    Aleena          15\n 3 Bespin         Human           79\n 4 Bestine IV     Human          110\n 5 Cato Neimoidia Neimodian       90\n 6 Cerea          Cerean          82\n 7 Champala       Chagrian        NA\n 8 Chandrila      Human           NA\n 9 Concord Dawn   Human           79\n10 Corellia       Human          157\n# … with 48 more rows\n```\n:::\n:::\n\n\nThere's some nice symmetry here in that we unwrap both `rlang::sym` and `quo` with `!!` and both `rlang::syms` and `quos` with `!!!`.\n\nWe might be interested in using this behavior in a function. To do this we replace calls to `quo` with calls to `enquo`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummarize_by <- function(df, to_summarize, ...) {\n\n  to_summarize <- enquo(to_summarize)  # enquo captures a single argument\n  groups <- quos(...)                  # quos captures multiple arguments\n\n  df %>%\n    group_by(!!!groups) %>%                 # unwrap quos with !!!\n    summarize(summ = sum(!!to_summarize))   # unwrap enquo with !!\n}\n```\n:::\n\n\nNow our function call is non-standardized. Note that `quos` can capture an arbitrary number of arguments, like we have here. So both of the following calls are valid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummarize_by(starwars, mass, homeworld)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 49 × 2\n   homeworld       summ\n   <chr>          <dbl>\n 1 Alderaan          NA\n 2 Aleen Minor       15\n 3 Bespin            79\n 4 Bestine IV       110\n 5 Cato Neimoidia    90\n 6 Cerea             82\n 7 Champala          NA\n 8 Chandrila         NA\n 9 Concord Dawn      79\n10 Corellia         157\n# … with 39 more rows\n```\n:::\n\n```{.r .cell-code}\nsummarize_by(starwars, mass, homeworld, species)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 58 × 3\n# Groups:   homeworld [49]\n   homeworld      species    summ\n   <chr>          <chr>     <dbl>\n 1 Alderaan       Human        NA\n 2 Aleen Minor    Aleena       15\n 3 Bespin         Human        79\n 4 Bestine IV     Human       110\n 5 Cato Neimoidia Neimodian    90\n 6 Cerea          Cerean       82\n 7 Champala       Chagrian     NA\n 8 Chandrila      Human        NA\n 9 Concord Dawn   Human        79\n10 Corellia       Human       157\n# … with 48 more rows\n```\n:::\n:::\n\n\nFor more details, see the [programming with `dplyr` vignette](http://dplyr.tidyverse.org/articles/programming.html).\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}